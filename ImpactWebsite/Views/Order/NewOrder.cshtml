@model IEnumerable<ImpactWebsite.Models.OrderModels.OrderDetail>
@using ImpactWebsite.Models.OrderModels

@{
    ViewData["Title"] = "New Order";
    IFormatProvider fp = new System.Globalization.CultureInfo("en-CA");
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{ string strSpacer = "&nbsp;&nbsp;"; }

<!-- page heading start-->
<div class="page-heading">
    <h3 class="inv-col">
        Order number:<span>@Html.Raw(strSpacer)@ViewData["OrderNumber"] </span>
    </h3>
    <ul class="breadcrumb">
        <li>
            Analysis
        </li>
        <li class="active">Upload portfolio</li>
    </ul>
</div>

<div class="wrapper">

    <div class="row">
        <div class="col-md-6">
            <section class="panel">
                <header class="panel-heading">
                    Upload portfolio
                    <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                    </span>
                </header>
                <div class="panel-body">

                    <form class="dropzone"
                          id="dropzoneForm"
                          asp-action="UploadFile"
                          asp-controller="Order"
                          method="post"
                          style="text-align:left !important">
                        <div class="fallback">
                            <input name="file" type="file" multiple />
                        </div>
                    </form>

                    <form id="noteFromUserForm" method="post" role="form">
                        <div class="form-group">
                            <textarea id="noteFromUser"
                                      name="noteFromUser"
                                      class="form-control"
                                      placeholder="Add any additional comments"
                                      rows="3"
                                      style="margin-top:20px; margin-bottom:20px;"></textarea>
                        </div>
                    </form>

                    <button id="submitFileComment" type="submit" value="Submit"
                            class="btn btn-primary input-icon">
                        <i class="fa fa-upload" aria-hidden="true"></i>
                        @Html.Raw(strSpacer)Upload file and comment
                    </button>

                    <div id="submitResult"></div>

                </div>
            </section>
        </div>

        <div class="col-md-6">
            <section class="panel">
                <header class="panel-heading">
                    Order summary
                    <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                    </span>
                </header>
                <div class="panel-body">
                    <table class="table table-hover general-table">
                        <thead>
                            <tr>
                                <td class="col-sm-4"></td>
                                <td class="col-sm-8"></td>
                            </tr>
                        </thead>
                        <tbody>
                            @{ var subTotal = 0;}
                            @for (int i = 0; i < Model.Count(); i++)
                            {
                                <tr></tr>
                                subTotal += Model.ElementAt(@i).Module.UnitPrice.Price;
                            }
                        </tbody>

                        <tr>
                            <td class="text-left">
                                Sub-total
                            </td>
                            <td>
                                $@subTotal
                            </td>
                        </tr>


                        <tr>
                            <td class="text-left text-danger">
                                Multiple module saving
                            </td>
                            @if (!object.Equals(ViewBag.SelectionDiscount, "0"))
                            {
                                <td class="text-danger">
                                    -$@ViewBag.SelectionDiscount
                                </td>
                            }
                            else
                            {
                                <td class="text-danger">
                                    0
                                </td>
                            }
                        </tr>
                        <tr>
                            <td class="text-left text-danger">
                                Promotion Discount
                            </td>

                            @if (!object.Equals((string)TempData["PromotionDiscountRate"], "0"))
                            {
                                <td class="text-danger">
                                    @TempData["PromotionDiscountRate"]
                                </td>
                            }
                            else
                            {
                                <td class="text-danger">
                                    0
                                </td>
                            }
                        </tr>

                        <tr>
                            <td style="font-size:medium; font-weight: bold;" align="left">
                                Total to pay :
                            </td>
                            @if (ViewData["TotalAmountToPay"] != null)
                            {
                                <td>
                                    <b>
                                        <label style="font-size: large;">$@ViewData["TotalAmountToPay"]</label>
                                    </b>
                                </td>
                            }
                            else
                            {
                                <td><b style="font-size: large;">0</b></td>
                            }
                        </tr>
                    </table>


                    @if (ViewBag.PromotionStatus == PromotionStatusList.Ready)
                    {
                        <button id="promoCode"
                                asp-controller="Order"
                                asp-action="SubmitPromoCode"
                                class="btn btn-success">
                            <i class="fa fa-barcode" aria-hidden="true"></i>
                            @Html.Raw(strSpacer)Promotion Code
                        </button>
                    }
                    else if (ViewBag.PromotionStatus == PromotionStatusList.Applied)
                    {
                        <button class="btn btn-success disabled" pointer-events:none;">

                            <i class="fa fa-check" aria-hidden="true"></i>
                            @Html.Raw(strSpacer)Applied

                        </button>
                    }
                    else if (ViewBag.PromotionStatus == PromotionStatusList.Used)
                    {
                        <button id="promoCode"
                                asp-controller="Order"
                                asp-action="SubmitPromoCode"
                                class="btn btn-success">

                            <i class="fa fa-barcode" aria-hidden="true"></i>
                            @Html.Raw(strSpacer)Promotion Code

                        </button>
                        <p style="text-align:center; margin-top:20px;" class="text-danger">
                            The promotion code is already used
                        </p>
                    }

                    <br />
                    @if (SignInManager.IsSignedIn(User))
                    {
                        <a href="@Url.Action("Index", "Billing", new { @orderId = ViewData["OrderId"] })"
                           class="btn btn-primary btn-new-order"
                           role="button"
                           id="proceedButton">
                            Proceed to payment&nbsp;
                            <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </a>
                    }
                    else
                    {
                        <a id="proceedButton"
                           asp-controller="Order"
                           asp-action="CheckTempUser"
                           asp-route-id="@ViewData["OrderId"]"
                           class="btn btn-primary btn-new-order"
                           role="button">
                            Proceed to payment&nbsp;
                            <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </a>
                    }
                </div>

            </section>

        </div>
    </div>
</div>

<div id="addUserForm"></div>

@section scripts{

    <!--dropzone-->
    <link rel="stylesheet" href="~/lib/dropzone/dist/dropzone.css" />
    <link rel="stylesheet" href="~/lib/dropzone/dist/basic.css" />
    <script type="text/javascript" src="~/lib/dropzone/dist/dropzone.js"></script>

    <link rel="stylesheet" href="~/lib/jquery-ui/themes/base/jquery-ui.css" />
    <script type="text/javascript" src="~/lib/jquery-ui/jquery-ui.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $("#submitFileComment").on("click", function () {
                if ($("#noteFromUser").val() != "") {

                    var noteFromUser = { noteFromUser: $("#noteFromUser").val() }

                    $.ajax({
                        type: "POST",
                        url: "/Order/SubmitNote",
                        data: noteFromUser,
                        dataType: "json",
                        success: function (result, status, xhr) {
                            $("#submitResult").text(result);
                            $("#submitResult").html(status);
                            alert(result);
                        },
                    });
                }
            });
        });
    </script>

    <script type="text/javascript">

        //File Upload response from the server
        Dropzone.options.dropzoneForm = {

            maxFiles: 5,
            //Set Dropzone from uploading dropped files immediately
            autoProcessQueue: false,
            paramName: "file",

            init: function () {
                var submitButton = document.querySelector("#submitFileComment");
                var myDropzone = this; //closure

                // Set Dropzone use button to upload
                submitButton.addEventListener("click", function () {
                    myDropzone.processQueue();
                });

                this.on("sending", function (file, xhr, formData) {
                    formData.append("noteFromUser", $("#noteFromUser").val());
                });

                this.on("maxfilesexceeded", function (data) {
                    var res = eval('(' + data.xhr.responseText + ')');
                });

                this.on("addedfile", function (file) {

                    // Create the remove button
                    var removeButton = Dropzone.createElement("<button class=\"btn btn-default\" style=\"margin-left:7px;margin-top:10px;\">Remove file</button>");

                    // Capture the Dropzone instance as closure.
                    var _this = this;

                    // Listen to the click event
                    removeButton.addEventListener("click", function (e) {
                        // Make sure the button click doesn't submit the form:
                        e.preventDefault();
                        e.stopPropagation();
                        // Remove the file preview.
                        _this.removeFile(file);
                        // If you want to the delete the file on the server as well,
                        // you can do the AJAX request here.
                    });
                    // Add the button to the file preview element.
                    file.previewElement.appendChild(removeButton);
                });
            }
        }
    </script>

    <script type="text/javascript">
        $("#promoCode").on("click", function () {
            $("#addUserForm").dialog({
                type: "GET",
                autoOpen: true,
                resizable: true,
                modal: true,
                draggable: false,
                title: "Enter your promotion code",
                position: { my: "top", at: "top+50", of: window },
                show: {
                    effect: "drop", direction: "up", duration: 300
                },
                hide: {
                    effect: "drop", direction: "up", duration: 300
                },
                width: 600,
                height: 200,

                open: function () {
                    $(this).load('@Url.Action("SubmitPromoCode", "Order")');
                },
            });
        return false;
        });
    </script>

    <script type="text/javascript">
        $("#proceedButton").on("click", function () {
            if ($("#noteFromUser").val() != null) {
            }
        });
    </script>
}

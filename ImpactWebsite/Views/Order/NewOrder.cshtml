@model IEnumerable<ImpactWebsite.Models.OrderModels.OrderDetail>
@using ImpactWebsite.Models.OrderModels

@{
    ViewData["Title"] = "New Order";
    IFormatProvider fp = new System.Globalization.CultureInfo("en-CA");
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{ string strSpacer = "&nbsp;&nbsp;"; }

<!-- page heading start-->
<div class="page-heading">
    <h3 class="inv-col">
        Order number:<span>@Html.Raw(strSpacer)@ViewData["OrderNumber"] </span>
</h3>
    <ul class="breadcrumb">
        <li>
            Analysis
        </li>
        <li class="active">Upload portfolio</li>
    </ul>
</div>

<div class="wrapper">

    <div class="row">
        <div class="col-md-6">
            <section class="panel">
                <header class="panel-heading">
                    Upload portffolio
                    <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                    </span>
                </header>
                <div class="panel-body">

                    <form class="dropzone"
                          id="dropzoneForm"
                          asp-action="UploadFile"
                          asp-controller="Order"
                          method="post"
                          style="text-align:left !important">
                        <div class="fallback">
                            <input name="file" type="file" multiple />
                        </div>
                    </form>

                    <textarea id="noteFromUser"
                              class="form-control"
                              placeholder="Add any additional comments"
                              rows="3"
                              style="margin-top:20px; margin-bottom:20px;"></textarea>

                    <input role="button" id="submitFileComment" class="btn btn-primary input-icon"                           
                           value="&#xf093;@Html.Raw(strSpacer)Upload file and comment " />

                </div>
            </section>
        </div>

        <div class="col-md-6">
            <section class="panel">
                <header class="panel-heading">
                    Order summary
                    <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                    </span>
                </header>
                <div class="panel-body">
                    <table class="table table-hover general-table">
                        <thead>
                            <tr>
                                <td class="col-sm-0"></td>
                                <td class="col-sm-1"></td>
                                <td class="col-sm-11"></td>
                            </tr>
                        </thead>
                        <tbody>
                            @{ var subTotal = 0;}
                            @for (int i = 0; i < Model.Count(); i++)
                            {
                                <tr>
                                </tr>
                                subTotal += Model.ElementAt(@i).Module.UnitPrice.Price;
                            }
                        </tbody>

                        <tr>
                            <td></td>
                            <td class="text-left">
                                Sub-total
                            </td>
                            <td>
                                $@subTotal
                            </td>
                        </tr>


                        <tr>
                            <td></td>
                            <td class="text-left text-danger">
                                Saving
                            </td>
                            @if (!object.Equals(ViewBag.SelectionDiscount, "0"))
                            {
                                <td class="text-danger">
                                    -$@ViewBag.SelectionDiscount
                                </td>
                            }
                            else
                            {
                                <td class="text-danger">
                                    0
                                </td>
                            }
                        </tr>
                        <tr>
                            <td></td>
                            <td class="text-left text-danger">
                                Promotion Discount
                            </td>

                            @if (!object.Equals((string)TempData["PromotionDiscountRate"], "0"))
                            {
                                <td class="text-danger">
                                    @TempData["PromotionDiscountRate"]
                                </td>
                            }
                            else
                            {
                                <td class="text-danger">
                                    0
                                </td>
                            }
                        </tr>

                        <tr>
                            <td></td>
                            <td style="font-size:medium; font-weight: bold;" align="left">
                                Total to pay :
                            </td>
                            @if (ViewData["TotalAmountToPay"] != null)
                            {
                                <td>
                                    <b>
                                        <label style="font-size: large;">$@ViewData["TotalAmountToPay"]</label>
                                    </b>
                                </td>
                            }
                            else
                            {
                                <td><b style="font-size: large;">0</b></td>
                            }
                        </tr>

                        <tr>
                            <td></td>
                            <td>
                                @if (ViewBag.PromotionStatus == PromotionStatusList.Ready)
                                {
                                    <button id="promoCode"
                                            asp-controller="Order"
                                            asp-action="SubmitPromoCode"
                                            class="btn btn-success pull-left">

                                        <i class="fa fa-barcode" aria-hidden="true"></i>
                                        @Html.Raw(strSpacer)Promotion Code

                                    </button>
                                }
                                else if (ViewBag.PromotionStatus == PromotionStatusList.Applied)
                                {
                                    <button class="btn btn-default pull-left" pointer-events:none;">

                                        <i class="fa fa-check" aria-hidden="true"></i>
                                        @Html.Raw(strSpacer)Applied

                                    </button>
                                }
                                else if (ViewBag.PromotionStatus == PromotionStatusList.Used)
                                {
                                    <button id="promoCode"
                                            asp-controller="Order"
                                            asp-action="SubmitPromoCode"
                                            class="btn btn-default pull-left">

                                        <i class="fa fa-barcode" aria-hidden="true"></i>
                                        @Html.Raw(strSpacer)Promotion Code

                                    </button>
                                    <p style="text-align:center; margin-top:20px;" class="text-danger">
                                        The promotion code is already used
                                    </p>
                                }

                                </td>
                            <td></td>
                        </tr>
                    </table>

                    @if (SignInManager.IsSignedIn(User))
                    {
                        <a href="@Url.Action("Index", "Billing", new { @orderId = ViewData["OrderId"] })"
                           class="btn btn-primary btn-lg"
                           style="color:white; margin:15px 0 5px 5px;"
                           role="button"
                           id="charge">
                            Proceed to payment&nbsp;
                            <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </a>
                    }
                    else
                    {
                        <a id="charge"
                           asp-controller="Order"
                           asp-action="RegisterLogin"
                           asp-route-id="@ViewData["OrderId"]"
                           class="btn btn-primary btn-lg"
                           style="color:white; margin:15px 0 5px 5px;"
                           role="button">
                            Proceed to payment&nbsp;
                            <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </a>
                    }
                </div>

            </section>

        </div>
    </div>
</div>

<div id="AddUserForm"></div>

@section scripts{

    <!--dropzone-->
    <link rel="stylesheet" href="~/lib/dropzone/dist/dropzone.css" />
    <link rel="stylesheet" href="~/lib/dropzone/dist/basic.css" />
    <script type="text/javascript" src="~/lib/dropzone/dist/dropzone.js"></script>

    <link rel="stylesheet" href="~/lib/jquery-ui/themes/base/jquery-ui.css" />

    <script type="text/javascript">

        //File Upload response from the server
        Dropzone.options.dropzoneForm = {

            maxFiles: 5,
            //Set Dropzone from uploading dropped files immediately
            autoProcessQueue: false,
            paramName: "file",

            init: function () {
                var submitButton = document.querySelector("#submitFileComment");
                var myDropzone = this; //closure

                // Set Dropzone use button to upload
                submitButton.addEventListener("click", function () {
                    myDropzone.processQueue();
                });

                this.on("sending", function (file, xhr, formData) {
                    formData.append("noteFromUser", $("#noteFromUser").val());
                });

                this.on("maxfilesexceeded", function (data) {
                    var res = eval('(' + data.xhr.responseText + ')');
                });

                this.on("addedfile", function (file) {

                    // Create the remove button
                    var removeButton = Dropzone.createElement("<button class=\"btn btn-default\" style=\"margin-left:7px;margin-top:10px;\">Remove file</button>");

                    // Capture the Dropzone instance as closure.
                    var _this = this;

                    // Listen to the click event
                    removeButton.addEventListener("click", function (e) {
                        // Make sure the button click doesn't submit the form:
                        e.preventDefault();
                        e.stopPropagation();
                        // Remove the file preview.
                        _this.removeFile(file);
                        // If you want to the delete the file on the server as well,
                        // you can do the AJAX request here.
                    });
                    // Add the button to the file preview element.
                    file.previewElement.appendChild(removeButton);
                });
            }
        }
    </script>




    <script type="text/javascript">
        $('#promoCode').on('click', function () {
            $("#AddUserForm").dialog({
            type: 'GET',
            autoOpen: true,
            position: { my: "top", at: "top+150", of: window },
            width: 400,
            height: 150,
            resizable: true,
            title: 'Enter your promotional code',
            modal: true,
            open: function () {
                $(this).load('@Url.Action("SubmitPromoCode", "Order")');
            },
        });
        return false;
        });
    </script>

    <script type="text/javascript">
        $('#FileUpload').on('click', function () {

            $("#AddUserForm").dialog({
            type: 'GET',
            autoOpen: true,
            position: { my: "top", at: "top+100", of: window },
            width: 500,
            height: 400,
            resizable: true,
            title: 'Upload files and add comments',
            modal: true,
            open: function () {
                $(this).load('@Url.Action("FileCommentSubmit", "Order")');
            },
        });
        return false;
    });
    </script>
}
